# Правила проекта Guitar Combat

## Архитектура хранения аккордов

### ChordStore
Централизованное хранилище аккордов с привязкой к тактам и стрелкам.

**Основные возможности:**
- Хранение аккордов с привязкой к такту и позиции стрелки
- Автоматическое обновление при изменении поля ввода аккордов
- Сохранение и загрузка из localStorage
- Система уведомлений об изменениях

**Структура данных:**
- `chordsArray` - массив аккордов из поля ввода (в порядке ввода)
- `chordMap` - карта: Map<barIndex, Map<arrowIndex, chordName>>
  - Для каждого такта хранится карта: на какой стрелке какой аккорд
  - По умолчанию аккорд привязывается к стрелке 0 (первой стрелке такта)

**Методы:**
- `updateFromString(chordsString)` - обновить из строки ввода
- `getChordForPosition(barIndex, arrowIndex)` - получить аккорд для позиции
- `setChordForPosition(barIndex, arrowIndex, chordName)` - установить аккорд для позиции
- `getChordForBar(barIndex)` - получить аккорд для такта (стрелка 0)
- `getNextChord(currentBarIndex)` - получить следующий аккорд в последовательности

## Логика воспроизведения

### Порядок воспроизведения
1. При нажатии на кнопку Play запускается `Playback.startPlayback()`
2. `Metronome.start()` начинает отсчёт тактов
3. На каждый удар метронома вызывается `onBeatCallback(arrowIndex, barIndex)`
4. В колбэке:
   - Обновляется подсветка стрелочки через `beatRow.setCurrentIndex(arrowIndex)`
   - Обновляются аккорды через `metronome.updateChordDisplay(arrowIndex, barIndex)`
   - При смене такта обновляются слоги через `barSyllableDisplay.goToBar(barIndex)`

### Синхронизация аккордов
- При воспроизведении аккорды берутся из `ChordStore.getChordForPosition(barIndex, arrowIndex)`
- При смене такта `ChordDisplay` получает текущий и следующий аккорд из `ChordStore`
- Звук гитары генерируется на основе аккорда из `ChordStore`

## Изменения в поле ввода аккордов
При вводе аккордов в `#chordsInput`:
1. `ChordStore.updateFromString()` парсит строку и обновляет хранилище
2. `ChordStore.saveToLocalStorage()` сохраняет изменения
3. `ChordDisplay` обновляется с новыми аккордами для текущего такта
4. Если воспроизведение активно - аккорды обновляются на лету

## Важные принципы
- **Один такт = один аккорд** (по умолчанию на первой стрелке)
- **Зацикливание**: если тактов больше, чем аккордов - аккорды повторяются
- **Обратная совместимость**: сохранена старая логика через ChordManager для fallback
- **Автосохранение**: все изменения в ChordStore автоматически сохраняются в localStorage


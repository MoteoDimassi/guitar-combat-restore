<!-- 4426e8ba-4574-4034-a640-139a2c6d2c31 0b203aa6-cd51-47e4-ab93-9687d001082b -->
# План: Система частей песни

## 1. Создание модели SongPart

Создать `js/models/SongPart.js` для представления части песни:

- `name` - название части (Куплет 1, Припев 2)
- `type` - тип части (куплет, припев, предприпев и т.д.)
- `startBarIndex` - индекс первого такта
- `endBarIndex` - индекс последнего такта
- `chords` - массив аккордов для этой части
- `strumPattern` - бой для этой части (если отличается)

## 2. Создание SongPartManager

Создать `js/managers/SongPartManager.js` для управления частями:

- Словарь ключевых слов для распознавания частей: куплет, припев, предприпев, вступление, соло, проигрыш
- `parseSongText(text)` - парсинг текста на части
  - Поиск ключевых слов (регистронезависимо)
  - Автоматическая нумерация одинаковых частей
  - Создание "Часть N" для текста без маркеров (по пустым строкам)
- `getCurrentPart(barIndex)` - определение части по индексу такта
- `getPartByName(name)` - получение части по названию
- `detectPartChanges(part1, part2)` - сравнение настроек между одинаковыми частями
- `copyPartSettings(fromPart, toPart)` - копирование настроек между частями

## 3. Модификация BarManager

Обновить `js/managers/BarManager.js`:

- Не фильтровать ключевые слова частей при парсинге текста
- Передавать их в SongPartManager для создания структуры частей
- Добавить маппинг такт → часть песни

## 4. Модификация Bar

Обновить `js/models/Bar.js`:

- Добавить поле `partId` - идентификатор части песни
- При изменении аккордов/боя сохранять изменения только для тактов текущей части

## 5. Обновление ChordStore

Модифицировать `js/components/ChordStore.js`:

- Хранить аккорды с привязкой к части песни: `Map<partId, Map<barIndex, Map<arrowIndex, chordName>>>`
- При изменении аккордов применять только к тактам текущей части
- `updateChordsForPart(partId, chordsArray)` - обновление аккордов для части
- `getChordsForPart(partId)` - получение аккордов части

## 6. UI: Кнопки частей песни

Создать `js/components/SongPartNavigation.js`:

- Отображение кнопок частей над полем "Аккорды" (строка 76 в index.html)
- Горизонтальный ряд кнопок с названиями частей
- При клике на кнопку:
  - Переход к первому такту части
  - Обновление поля аккордов на аккорды этой части
  - Обновление боя (если отличается)
  - Обновление слогов под стрелками
- Подсветка активной части

HTML для вставки в `index.html` после строки 75:

```html
<div id="song-parts-nav" class="w-full mb-3 hidden">
  <div class="flex items-center gap-2 overflow-x-auto pb-2">
    <!-- Кнопки частей будут генерироваться динамически -->
  </div>
</div>
```

## 7. Кнопка импорта настроек

Создать `js/components/PartSettingsImport.js`:

- Отслеживание изменений в частях одного типа
- Показ кнопки "Импорт настроек из [Часть X]" при обнаружении различий
- Применение настроек (аккорды + бой) из одной части в другую

Кнопка появляется рядом с полем аккордов, когда:

- Текущая часть отличается от другой части того же типа
- Есть откуда импортировать настройки

## 8. Интеграция с существующей системой

Обновить `js/main.js`:

- Инициализация SongPartManager
- Связка с BarManager при загрузке текста песни
- Обновление ChordStore для работы с частями
- Обработка событий изменения аккордов с учетом текущей части

Обновить `js/components/Modal.js` → `displaySongText()`:

- После парсинга текста вызывать `SongPartManager.parseSongText()`
- Инициализировать кнопки навигации по частям
- Скрывать/показывать панель частей

## 9. Обновление PlaybackSync

Модифицировать `js/components/PlaybackSync.js`:

- При смене такта проверять, изменилась ли часть песни
- При смене части обновлять:
  - Поле аккордов
  - Бой (если он отличается)
  - Подсветку активной кнопки части

## 10. Сохранение и загрузка

Обновить экспорт/импорт:

- `SongExporter` - включить данные о частях песни
- `SongImporter` - восстанавливать структуру частей
- LocalStorage - сохранять настройки частей отдельно

## Технические детали

### Структура данных части:

```javascript
{
  id: "part_1",
  name: "Куплет 1",
  type: "куплет",
  startBarIndex: 0,
  endBarIndex: 3,
  chords: ["Am", "F", "C", "G"],
  strumPattern: null // null = использовать глобальный бой
}
```

### Алгоритм парсинга текста:

1. Разбить текст на блоки по пустым строкам
2. Для каждого блока проверить первую строку на ключевые слова
3. Если найдено - создать часть с соответствующим типом
4. Если не найдено - создать "Часть N"
5. Пронумеровать одинаковые типы (Куплет 1, Куплет 2)

### Приоритет применения настроек:

1. Настройки конкретной части (если установлены)
2. Глобальные настройки (если в части не переопределены)

### To-dos

- [] Создать модель SongPart для представления части песни
- [] Создать SongPartManager для парсинга и управления частями
- [] Обновить BarManager для работы с частями песни
- [] Добавить поле partId в модель Bar
- [] Модифицировать ChordStore для хранения аккордов по частям
- [] Создать компонент навигации по частям песни
- [] Добавить контейнер для кнопок частей в index.html
- [] Создать компонент импорта настроек между частями
- [] Интегрировать систему частей в main.js
- [] Обновить Modal для инициализации частей при загрузке текста
- [] Обновить PlaybackSync для отслеживания смены частей
- [] Обновить SongExporter и SongImporter для работы с частями